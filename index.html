<script>
function render(rows){
  const out = document.getElementById('results');
  if(!rows.length){
    out.innerHTML = '<div class="muted">Sin resultados. Ajusta filtros.</div>';
    return;
  }

  // Columnas relevantes (ya mapeadas en tu código actual)
  const catCol = KEYS.categoria, armCol = KEYS.armadora, marCol = KEYS.marca, subCol = KEYS.submarca, modCol = KEYS.modelo, desCol = KEYS.descripcion;
  const preCol = KEYS.precio, invCol = KEYS.inventario, parCol = KEYS.part;

  // Si no tenemos columna de Número de parte, render tradicional (una tarjeta por fila)
  if(!parCol){
    const MAX=200, slice=rows.slice(0,MAX);
    out.innerHTML = slice.map(r=>{
      const cat   = catCol ? v(r[catCol]) : '';
      const arm   = armCol ? v(r[armCol]) : '';
      const marc  = marCol ? v(r[marCol]) : '';
      const subm  = subCol ? v(r[subCol]) : '';
      const mod   = modCol ? v(r[modCol]) : '';
      const desc  = desCol ? v(r[desCol]) : '';
      const precio= preCol ? fmtMoneyMX(r[preCol]) : '—';
      const inv   = invCol ? v(r[invCol]) : '';
      const invClass = inv ? (isOutOfStock(inv) ? 'inv-bad' : 'inv-ok') : '';
      return `
        <div class="result">
          <div><span class="badge">Producto</span> <strong>${desc || (cat+' '+marc+' '+subm).trim()}</strong></div>
          <div><span class="badge">Compatible con</span> ${arm} ${marc} ${subm} ${mod}</div>
          <div><span class="badge">Precio</span> ${precio}</div>
          ${inv ? `<div><span class="badge">Inventario</span> <span class="${invClass}">${inv}</span></div>` : ``}
        </div>
      `;
    }).join('');
    return;
  }

  // ====== Agrupación por Número de parte ======
  const groups = new Map();   // part -> { rows:[], first:row }
  const noPartRows = [];      // filas sin número de parte (se renderizan individualmente)

  rows.forEach(r=>{
    const part = v(r[parCol]);
    if(!part){ noPartRows.push(r); return; }
    if(!groups.has(part)) groups.set(part, { rows: [], first: r });
    groups.get(part).rows.push(r);
  });

  // Construye tarjetas por grupo
  const CARDS = [];
  const MAX_GROUPS = 200; // seguridad para no saturar UI
  let count = 0;

  for(const [part, grp] of groups.entries()){
    if(count >= MAX_GROUPS) break;
    count++;

    const first = grp.first;

    // Datos base del grupo: tomamos del primer renglón
    const cat   = catCol ? v(first[catCol]) : '';
    const desc  = desCol ? v(first[desCol]) : '';
    const precio= preCol ? fmtMoneyMX(first[preCol]) : '—';
    const inv   = invCol ? v(first[invCol]) : '';
    const invClass = inv ? (isOutOfStock(inv) ? 'inv-bad' : 'inv-ok') : '';

    // Lista de compatibilidades (dedup armadora+marca+submarca+modelo)
    const compatSet = new Set();
    grp.rows.forEach(r=>{
      const arm  = armCol ? v(r[armCol]) : '';
      const marc = marCol ? v(r[marCol]) : '';
      const subm = subCol ? v(r[subCol]) : '';
      const mod  = modCol ? v(r[modCol]) : '';
      const line = [arm, marc, subm, mod].filter(Boolean).join(' ').replace(/\s+/g,' ').trim();
      if(line) compatSet.add(line);
    });

    // Para no hacer la tarjeta infinita: mostramos hasta 12 y luego “+N más”
    const compatList = Array.from(compatSet);
    const MAX_COMP = 12;
    const shown = compatList.slice(0, MAX_COMP);
    const extra = compatList.length - shown.length;

    const compatHTML = `
      <ul style="margin:6px 0 0 0; padding-left:18px;">
        ${shown.map(c=>`<li>${c}</li>`).join('')}
        ${extra>0 ? `<li class="muted">+${extra} más…</li>` : ``}
      </ul>
    `;

    CARDS.push(`
      <div class="result">
        <div><span class="badge">Producto</span> <strong>${desc || (cat || '')}</strong></div>
        <div><span class="badge">N.º de parte</span> ${part}</div>
        <div><span class="badge">Compatible con</span> ${compatHTML}</div>
        <div><span class="badge">Precio</span> ${precio}</div>
        ${inv ? `<div><span class="badge">Inventario</span> <span class="${invClass}">${inv}</span></div>` : ``}
      </div>
    `);
  }

  // Filas sin número de parte: render tradicional
  noPartRows.forEach(r=>{
    const cat   = catCol ? v(r[catCol]) : '';
    const arm   = armCol ? v(r[armCol]) : '';
    const marc  = marCol ? v(r[marCol]) : '';
    const subm  = subCol ? v(r[subCol]) : '';
    const mod   = modCol ? v(r[modCol]) : '';
    const desc  = desCol ? v(r[desCol]) : '';
    const precio= preCol ? fmtMoneyMX(r[preCol]) : '—';
    const inv   = invCol ? v(r[invCol]) : '';
    const invClass = inv ? (isOutOfStock(inv) ? 'inv-bad' : 'inv-ok') : '';
    CARDS.push(`
      <div class="result">
        <div><span class="badge">Producto</span> <strong>${desc || (cat+' '+marc+' '+subm).trim()}</strong></div>
        <div><span class="badge">Compatible con</span> ${arm} ${marc} ${subm} ${mod}</div>
        <div><span class="badge">Precio</span> ${precio}</div>
        ${inv ? `<div><span class="badge">Inventario</span> <span class="${invClass}">${inv}</span></div>` : ``}
      </div>
    `);
  });

  out.innerHTML = CARDS.join('');
}
</script>
