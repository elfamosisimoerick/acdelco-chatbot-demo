<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catálogo ACDelco (capas + número de parte, precio e inventario)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --text:#e2e8f0; --card:#111827; --stroke:#1f2937; --muted:#94a3b8; --accent:#2563eb;
    --ok:#16a34a; /* verde */
    --bad:#dc2626; /* rojo */
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:var(--bg);color:var(--text)}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  h1{font-size:20px;margin:12px 0 16px;color:#93c5fd}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px;margin-bottom:16px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  select{width:100%;padding:10px;background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:8px;outline:none}
  select:focus{border-color:#60a5fa}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 14px;border-radius:8px;border:1px solid #334155;background:var(--accent);color:#fff;cursor:pointer}
  button:disabled{background:#334155;cursor:not-allowed}
  .result{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:14px;margin-bottom:12px}
  .badge{display:inline-block;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
  .muted{color:var(--muted);font-size:13px}
  .inv-ok{color:var(--ok);font-weight:600}
  .inv-bad{color:var(--bad);font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <h1>Catálogo ACDelco — por capas</h1>

  <div class="card">
    <div id="filters" class="grid"></div>
    <div class="row">
      <button id="buscar" disabled>Buscar</button>
      <button id="limpiar" type="button">Limpiar</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

  <div id="results"></div>
</div>

<script>
/* ========= Config ========= */
const FILE_URL = 'PRUEBAS.xlsx'; // Cambia aquí si tu archivo se llama distinto
const SKIP = '— Saltar nivel (vacío) —';

/* Cabeceras esperadas + sinónimos (tolerante a acentos/mayús/minús) */
const CANDS = {
  categoria:['categoria','categoría'],
  armadora:['armadora'],
  marca:['marca'],
  submarca:['submarca','sub-marca'],
  modelo:['modelo'],
  descripcion:['descripcion','descripción','description'],
  precio:['precio','price'],
  inventario:['inventario','existencia','existencias','stock'], // << usamos INVENTARIO
  part:['numero de parte','número de parte','num de parte','no. parte','no parte','sku','codigo','código','codigo de parte','código de parte','clave','refaccion','refacción']
};

/* ========= Utilidades ========= */
function nrm(s){return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();}
function v(x){return (x==null?'':(''+x)).trim();}
function uniq(a){return Array.from(new Set(a)).sort();}
function toNumberLoose(s){
  // extrae primer número en el string; si no hay, intenta parseFloat
  const m = (s||'').toString().match(/-?\d+([.,]\d+)?/);
  if(m){ return parseFloat(m[0].replace(',','.')) }
  const n = parseFloat((s||'').toString().replace(',','.'));
  return isNaN(n) ? null : n;
}
function isOutOfStock(txt){
  const t = v(txt).toLowerCase();
  if(!t) return true;
  if(/agotad|sin exist|no hay|no disponible|0(?!\d)/.test(t)) return true;
  const num = toNumberLoose(t);
  return num===0;
}

/* ========= Estado ========= */
let RAW=[], KEYS={}, FILTER_KEYS=[];
const state={};

/* ========= Carga del Excel ========= */
fetch(FILE_URL)
  .then(r=>r.arrayBuffer())
  .then(buf=>{
    const wb = XLSX.read(buf, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    RAW = XLSX.utils.sheet_to_json(ws); // fila 1 = encabezados
    init();
  })
  .catch(err=>{
    console.error(err);
    document.getElementById('status').textContent='No se pudo leer el Excel. ¿Está en la raíz y con el nombre correcto?';
  });

/* ========= Detección de encabezados ========= */
function mapKeys(keys){
  const nk=keys.map(k=>({orig:k,n:nrm(k)})); const out={};
  for(const [t,opts] of Object.entries(CANDS)){
    let f=null; for(const o of opts){const no=nrm(o); const hit=nk.find(x=>x.n===no); if(hit){f=hit.orig;break;}}
    out[t]=f;
  } return out;
}

/* ========= Inicialización de UI ========= */
function init(){
  const first=RAW[0]||{}; const all=Object.keys(first);
  KEYS = mapKeys(all);

  // Filtros por capas: Categoría → Armadora → Marca → Submarca → Modelo → Descripción (si existe)
  FILTER_KEYS = [
    KEYS.categoria, KEYS.armadora, KEYS.marca,
    KEYS.submarca, KEYS.modelo, KEYS.descripcion
  ].filter(Boolean);

  buildFilters();
  refreshOptions();

  document.getElementById('buscar').addEventListener('click',()=>{
    const rows=filtered(FILTER_KEYS.length-1);
    render(rows);
  });
  document.getElementById('limpiar').addEventListener('click',()=>{
    for(let i=0;i<FILTER_KEYS.length;i++) delete state[i];
    buildFilters(); refreshOptions(); render([]);
  });

  document.getElementById('status').textContent='Selecciona filtros y pulsa "Buscar".';
}

/* ========= Construcción de filtros ========= */
function buildFilters(){
  const c=document.getElementById('filters'); c.innerHTML='';
  FILTER_KEYS.forEach((key,idx)=>{
    const id='level_'+idx;
    const block=document.createElement('div');
    block.innerHTML=`<label>${key}</label><select id="${id}" ${idx>0?'disabled':''}><option value="">Selecciona…</option></select>`;
    c.appendChild(block);
    const sel=block.querySelector('select');
    sel.addEventListener('change',()=>{
      state[idx]=sel.value;
      for(let j=idx+1;j<FILTER_KEYS.length;j++){
        delete state[j];
        const s=document.getElementById('level_'+j);
        s.value=''; s.innerHTML='<option value="">Selecciona…</option>'; s.disabled=true;
      }
      refreshOptions();
      document.getElementById('buscar').disabled = Object.values(state).every(x=>!x);
    });
  });
}

/* ========= Lógica de filtrado ========= */
function filtered(upto){
  return RAW.filter(r=>{
    for(let i=0;i<=upto;i++){
      const key=FILTER_KEYS[i], chosen=state[i]||'', val=v(r[key]);
      if(!chosen) continue;                // sin filtro en ese nivel
      if(chosen===SKIP){ if(val!=='') return false; } // saltar vacíos
      else { if(val!==chosen) return false; }
    }
    return true;
  });
}

function fillSelect(idx){
  const key=FILTER_KEYS[idx];
  const sel=document.getElementById('level_'+idx);
  const base = idx>0 ? filtered(idx-1) : RAW.slice();

  const real=uniq(base.map(r=>v(r[key])).filter(Boolean));
  const hasEmpty = base.some(r=>v(r[key])==='');

  let opts = '<option value="">Selecciona…</option>';
  if(hasEmpty) opts += `<option value="${SKIP}">${SKIP}</option>`;
  opts += real.map(o=>`<option value="${o}">${o}</option>`).join('');
  sel.innerHTML = opts;

  sel.disabled = (real.length===0 && !hasEmpty && idx!==0);
  if(state[idx] && (state[idx]===SKIP || real.includes(state[idx]))){
    sel.value = state[idx]; sel.disabled=false;
  }
}

function refreshOptions(){ FILTER_KEYS.forEach((_,i)=>fillSelect(i)); }

/* ========= Render de resultados ========= */
function render(rows){
  const out=document.getElementById('results');
  if(!rows.length){ out.innerHTML='<div class="muted">Sin resultados. Ajusta filtros.</div>'; return; }

  const MAX=200;
  const slice=rows.slice(0,MAX);

  out.innerHTML = slice.map(r=>{
    const cat   = v(r[KEYS.categoria]||'');
    const arm   = v(r[KEYS.armadora]||'');
    const marc  = v(r[KEYS.marca]||'');
    const subm  = v(r[KEYS.submarca]||'');
    const mod   = v(r[KEYS.modelo]||'');
    const desc  = v(r[KEYS.descripcion]||'');
    const precio= KEYS.precio ? v(r[KEYS.precio]) : '—';
    const inv   = KEYS.inventario ? v(r[KEYS.inventario]) : ''; // INVENTARIO
    const parte = KEYS.part ? v(r[KEYS.part]) : '';              // Número de parte

    // clases de color para inventario
    const invClass = isOutOfStock(inv) ? 'inv-bad' : 'inv-ok';

    return `
      <div class="result">
        <div><span class="badge">Producto</span> <strong>${desc || (cat+' '+marc+' '+subm).trim()}</strong></div>
        <div><span class="badge">Compatible con</span> ${arm} ${marc} ${subm} ${mod}</div>
        ${parte ? `<div><span class="badge">N.º de parte</span> ${parte}</div>` : ``}
        <div><span class="badge">Precio</span> ${precio}</div>
        ${inv ? `<div><span class="badge">Inventario</span> <span class="${invClass}">${inv}</span></div>` : ``}
      </div>
    `;
  }).join('') + (rows.length>MAX?`<div class="muted" style="margin-top:8px">Mostrando ${MAX} de ${rows.length} resultados. Afina filtros.</div>`:'');
}
</script>
</body>
</html>
