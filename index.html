<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catálogo ACDelco (A→H)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0f172a;color:#e2e8f0}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  h1{font-size:20px;margin:12px 0 16px;color:#93c5fd}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px;margin-bottom:16px}
  label{display:block;font-size:12px;color:#94a3b8;margin-bottom:6px}
  select{width:100%;padding:10px;background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:8px;outline:none}
  select:focus{border-color:#60a5fa}
  .result{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:14px}
  .badge{display:inline-block;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
  .muted{color:#94a3b8;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Catálogo ACDelco — Capas A→H (con opción de saltar vacíos)</h1>

  <div class="card">
    <div id="filters" class="grid"></div>
    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

  <div id="results"></div>
</div>

<script>
// Encabezados EXACTOS por columnas A..H
const HEADERS = ["CATEGORÍA","ARMADORA","MARCA","SUBMARCA","MODELO","DESCRIPCIÓN","PRECIO","STOCK"];
const USE_LEVELS = HEADERS.slice(0,7); // A..G como filtros
const EXCLUDE_FROM_FILTER = new Set(["STOCK"]); // H se oculta
const SKIP_LABEL = "— Saltar nivel (vacío) —";

let DATA = [];
fetch('data.json')
  .then(r => r.json())
  .then(json => { DATA = normalize(json); init(); })
  .catch(err => {
    console.error(err);
    document.getElementById('status').textContent = 'No se pudo cargar data.json.';
  });

// normaliza: a string + trim
function v(x){ return (x == null ? "" : (""+x)).trim(); }
function normalize(rows){
  return rows.map(r => {
    const nr = {};
    HEADERS.forEach(h => nr[h] = v(r[h]));
    return nr;
  });
}

const state = {}; // selección por nivel
function init(){
  // Validar que existan headers esperados
  const missing = HEADERS.filter(h => !(h in (DATA[0]||{})));
  if(missing.length){
    document.getElementById('status').textContent = "Faltan columnas: " + missing.join(", ");
    return;
  }
  buildFilters();
  updateOptions();
}

function buildFilters(){
  const filters = document.getElementById('filters');
  filters.innerHTML = '';
  USE_LEVELS.forEach((key, idx) => {
    const id = 'level_'+idx;
    const block = document.createElement('div');
    block.innerHTML = `
      <label>${key}</label>
      <select id="${id}" ${idx>0?'disabled':''}>
        <option value="">Selecciona…</option>
      </select>
    `;
    filters.appendChild(block);
    const sel = block.querySelector('select');
    sel.addEventListener('change', () => {
      state[idx] = sel.value;
      for(let j=idx+1;j<USE_LEVELS.length;j++){
        delete state[j];
        const s = document.getElementById('level_'+j);
        s.value = '';
        s.innerHTML = '<option value="">Selecciona…</option>';
        s.disabled = true;
      }
      updateOptions();
    });
  });
}

function unique(list){ return Array.from(new Set(list)).sort(); }

function filteredRows(uptoIdx){
  return DATA.filter(r => {
    for(let i=0;i<=uptoIdx;i++){
      const k = USE_LEVELS[i];
      const chosen = state[i] || '';
      if(!chosen) continue;
      if(chosen === SKIP_LABEL){
        // si usuario "salta" el nivel, aceptamos vacío aquí
        if(r[k] !== '') return false;
      }else{
        if(r[k] !== chosen) return false;
      }
    }
    return true;
  });
}

function fillSelect(idx){
  const key = USE_LEVELS[idx];
  const sel = document.getElementById('level_'+idx);
  const prevIdx = idx-1;
  const base = prevIdx>=0 ? filteredRows(prevIdx) : DATA.slice();

  // opciones reales no vacías
  const real = unique(base.map(r => r[key]).filter(Boolean));
  // si hay filas con vacío en este nivel, permitimos "saltar"
  const hasEmpty = base.some(r => r[key] === '');

  let opts = '<option value="">Selecciona…</option>';
  if(hasEmpty) opts += `<option value="${SKIP_LABEL}">${SKIP_LABEL}</option>`;
  opts += real.map(o => `<option value="${o}">${o}</option>`).join('');
  sel.innerHTML = opts;

  // habilitar si hay algo que elegir
  sel.disabled = (real.length === 0 && !hasEmpty && idx !== 0);
}

function updateOptions(){
  USE_LEVELS.forEach((_, idx) => fillSelect(idx));

  const rows = filteredRows(USE_LEVELS.length-1);
  renderResults(rows);
  document.getElementById('status').textContent = rows.length ? `${rows.length} resultado(s)` : 'Selecciona filtros.';
}

function renderResults(rows){
  const out = document.getElementById('results');
  if(!rows.length){ out.innerHTML = ''; return; }

  out.innerHTML = rows.map(r => {
    const cat   = r["CATEGORÍA"] || '—';
    const armd  = r["ARMADORA"]  || '—';
    const marca = r["MARCA"]     || '';
    const subm  = r["SUBMARCA"]  || '';
    const model = r["MODELO"]    || '';
    const desc  = r["DESCRIPCIÓN"] || '';
    const price = r["PRECIO"]    || '—';
    return `
      <div class="result">
        <div><span class="badge">Producto</span> <strong>${desc || (cat+' '+marca+' '+subm).trim()}</strong></div>
        <div><span class="badge">Compatible con</span> ${armd} ${marca} ${subm} ${model}</div>
        <div><span class="badge">Precio</span> ${price}</div>
        <div class="muted">Refaccionaria El Pistón — demo (sin STOCK)</div>
      </div>
    `;
  }).join('');
}
</script>
</body>
</html>
